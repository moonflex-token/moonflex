<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>MoonFlex - Swap MFX and XRP</title>
    <link rel="icon" href="moonflex-favicon.png" type="image/png">
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Styles for the swap page, keeping the same design as the main page */
        body {
            font-family: 'Orbitron', sans-serif;
            background-color: #1e1e1e;
            color: white;
            margin: 0;
            padding: 0;
        }

        header {
            background-color: #333;
            padding: 10px 20px;
            text-align: center;
        }

        .container {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        h1, h2 {
            text-align: center;
        }

        .swap-section {
            display: flex;
            justify-content: space-around;
            margin-top: 30px;
        }

        .swap-box {
            background-color: #333;
            padding: 20px;
            border-radius: 8px;
            width: 45%;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        }

        .swap-box input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            border: 1px solid #ff6600;
            background-color: #1e1e1e;
            color: white;
        }

        .swap-button {
            background-color: #ff6600;
            color: white;
            padding: 10px;
            border: none;
            width: 100%;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        .swap-button:hover {
            background-color: #ffcc00;
        }

        .connect-wallet {
            background-color: #ff6600;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 20px;
            display: block;
            width: 100%;
        }

        .connect-wallet:hover {
            background-color: #ffcc00;
        }
    </style>
</head>

<body>
    <header>
        <nav>
            <ul id="menu">
                <li><a href="index.html">Home</a></li>
                <li><a href="swap.html">Swap</a></li>
                <li><a href="whitepaper.pdf" target="_blank">Whitepaper</a></li>
            </ul>
        </nav>
    </header>

    <div class="container">
        <h1>Swap XRP to MFX or MFX to XRP</h1>
        <h2>Connect your Xaman Wallet and start swapping!</h2>

        <!-- Wallet Connection -->
        <button id="connectWalletBtn" class="connect-wallet">Connect with Xaman Wallet</button>

        <div id="walletStatus" style="text-align: center; margin-top: 20px;"></div>

        <!-- Swap Section -->
        <div class="swap-section">
            <div class="swap-box">
                <h3>Swap XRP for MFX</h3>
                <input type="number" id="xrpAmount" placeholder="Amount of XRP" />
                <button class="swap-button" id="xrpToMfxBtn">Swap XRP for MFX</button>
            </div>

            <div class="swap-box">
                <h3>Swap MFX for XRP</h3>
                <input type="number" id="mfxAmount" placeholder="Amount of MFX" />
                <button class="swap-button" id="mfxToXrpBtn">Swap MFX for XRP</button>
            </div>
        </div>
    </div>

    <!-- Including XRPL.js and Xaman.js -->
    <script src="https://unpkg.com/xrpl/dist/xrpl.min.js"></script>
    <script src="https://unpkg.com/xaman/dist/xaman.min.js"></script>

    <script>
        let wallet;

        // Connect with Xaman Wallet
        document.getElementById("connectWalletBtn").addEventListener("click", async () => {
            const xaman = new Xaman();
            try {
                wallet = await xaman.connect();
                document.getElementById("walletStatus").innerText = `Connected to wallet: ${wallet.address}`;
            } catch (err) {
                alert("Failed to connect to Xaman wallet. Please try again.");
            }
        });

        // Swap XRP for MFX
        document.getElementById("xrpToMfxBtn").addEventListener("click", async () => {
            const xrpAmount = document.getElementById("xrpAmount").value;
            if (!wallet || !xrpAmount) {
                alert("Please connect wallet and enter a valid amount.");
                return;
            }

            try {
                const xrplClient = new xrpl.Client("wss://s2.ripple.com");
                await xrplClient.connect();

                const orderbook = await xrplClient.request({
                    command: "book_offers",
                    taker_pays: { currency: "XRP" },
                    taker_gets: { currency: "MFX", issuer: "rfUhMQYijKvStp96CUxDNp8ukYJAebNrJ1" }
                });

                const price = orderbook.offers[0] ? parseFloat(orderbook.offers[0].price) : 0;

                if (price > 0) {
                    const slippage = 1.01;
                    const maxPrice = price * slippage;
                    const finalAmount = xrpAmount * maxPrice;

                    // Create and submit transaction
                    const tx = {
                        TransactionType: "Payment",
                        Account: wallet.address,
                        Amount: xrpl.xrpToDrops(xrpAmount),
                        Destination: "rfUhMQYijKvStp96CUxDNp8ukYJAebNrJ1",
                        SendMax: xrpl.xrpToDrops(finalAmount),
                        Fee: "10",
                        Flags: 2147483648
                    };

                    const preparedTx = await xrplClient.autofill(tx);
                    const signedTx = wallet.sign(preparedTx);
                    const txResult = await xrplClient.submit(signedTx.tx_blob);

                    if (txResult.resultCode === "tesSUCCESS") {
                        alert("Transaction successful!");
                    } else {
                        alert("Transaction failed!");
                    }
                } else {
                    alert("No liquidity available.");
                }
                await xrplClient.disconnect();
            } catch (err) {
                alert("Error while swapping XRP for MFX: " + err.message);
            }
        });

        // Swap MFX for XRP
        document.getElementById("mfxToXrpBtn").addEventListener("click", async () => {
            const mfxAmount = document.getElementById("mfxAmount").value;
            if (!wallet || !mfxAmount) {
                alert("Please connect wallet and enter a valid amount.");
                return;
            }

            try {
                const xrplClient = new xrpl.Client("wss://s2.ripple.com");
                await xrplClient.connect();

                const orderbook = await xrplClient.request({
                    command: "book_offers",
                    taker_pays: { currency: "MFX", issuer: "rfUhMQYijKvStp96CUxDNp8ukYJAebNrJ1" },
                    taker_gets: { currency: "XRP" }
                });

                const price = orderbook.offers[0] ? parseFloat(orderbook.offers[0].price) : 0;

                if (price > 0) {
                    const slippage = 1.01;
                    const maxPrice = price * slippage;
                    const finalAmount = mfxAmount * maxPrice;

                    // Create and submit transaction
                    const tx = {
                        TransactionType: "Payment",
                        Account: wallet.address,
                        Amount: xrpl.xrpToDrops(finalAmount),
                        Destination: "rfUhMQYijKvStp96CUxDNp8ukYJAebNrJ1",
                        SendMax: xrpl.xrpToDrops(mfxAmount),
                        Fee: "10",
                        Flags: 2147483648
                    };

                    const preparedTx = await xrplClient.autofill(tx);
                    const signedTx = wallet.sign(preparedTx);
                    const txResult = await xrplClient.submit(signedTx.tx_blob);

                    if (txResult.resultCode === "tesSUCCESS") {
                        alert("Transaction successful!");
                    } else {
                        alert("Transaction failed!");
                    }
                } else {
                    alert("No liquidity available.");
                }
                await xrplClient.disconnect();
            } catch (err) {
                alert("Error while swapping MFX for XRP: " + err.message);
            }
        });
    </script>
</body>

</html>
