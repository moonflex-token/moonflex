<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Price Widget</title>
</head>
<body>
    <h2>Price Widget</h2>
    <div>
        <p>XRP/USD: <span id="xrp-usd-price">Loading...</span></p>
        <p>MFX/USD: <span id="mfx-usd-price">Loading...</span></p>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/xrpl@1.10.0/dist/xrpl.min.js"></script>
    <script>
        // Set up XRPL client
        const client = new xrpl.Client("wss://s.altnet.rippletest.net:51233");

        // Gatehub USD issued address (used for XRP/USD price)
        const gatehubUSDAddress = "rDsbeomngU9GdyZ3cVfqPp6nsm5u5MQ5v4"; // Gatehub's USD issued address

        // MFX issuer address (used for MFX/XRP price)
        const mfxIssuerAddress = "rfUhMQYijKvStp96CUxDNp8ukYJAebNrJ1"; // MFX issuer

        // Function to fetch XRP/USD price
        async function fetchXRPUSD() {
            console.log("Fetching XRP/USD price...");
            try {
                await client.connect();
                const request = {
                    "command": "account_lines",
                    "account": gatehubUSDAddress
                };

                const response = await client.request(request);
                console.log("XRP/USD account lines response:", response);
                
                const xrpUsdLine = response.result.lines.find(line => line.currency === "USD");
                if (xrpUsdLine) {
                    const xrpUsdPrice = xrpUsdLine.balance;
                    console.log("XRP/USD price found:", xrpUsdPrice);
                    return parseFloat(xrpUsdPrice);
                } else {
                    console.error("USD line not found in account lines response.");
                    return 0;
                }
            } catch (error) {
                console.error("Error fetching XRP/USD price:", error);
                return 0;
            }
        }

        // Function to fetch MFX/XRP price
        async function fetchMFXPriceInXRP() {
            console.log("Fetching MFX/XRP price...");
            try {
                const request = {
                    "command": "account_lines",
                    "account": mfxIssuerAddress
                };

                const response = await client.request(request);
                console.log("MFX/XRP account lines response:", response);
                
                const mfxXrpLine = response.result.lines.find(line => line.currency === "MFX");
                if (mfxXrpLine) {
                    const mfxXrpPrice = mfxXrpLine.balance;
                    console.log("MFX/XRP price found:", mfxXrpPrice);
                    return parseFloat(mfxXrpPrice);
                } else {
                    console.error("MFX line not found in account lines response.");
                    return 0;
                }
            } catch (error) {
                console.error("Error fetching MFX/XRP price:", error);
                return 0;
            }
        }

        // Main function to calculate MFX/USD
        async function fetchPrices() {
            console.log("Starting to fetch prices...");
            const xrpUsdPrice = await fetchXRPUSD();
            const mfxXrpPrice = await fetchMFXPriceInXRP();

            if (xrpUsdPrice === 0 || mfxXrpPrice === 0) {
                console.error("Error: One or more prices are 0, unable to calculate MFX/USD.");
                document.getElementById("xrp-usd-price").textContent = "Error fetching prices";
                document.getElementById("mfx-usd-price").textContent = "Error fetching prices";
            } else {
                const mfxUsdPrice = mfxXrpPrice * xrpUsdPrice;
                console.log("MFX/USD price:", mfxUsdPrice);
                document.getElementById("xrp-usd-price").textContent = `$${xrpUsdPrice.toFixed(2)}`;
                document.getElementById("mfx-usd-price").textContent = `$${mfxUsdPrice.toFixed(2)}`;
            }

            client.disconnect();
        }

        // Call the function to fetch and display the prices
        fetchPrices();
    </script>
</body>
</html>
